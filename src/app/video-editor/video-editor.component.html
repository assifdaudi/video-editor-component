<section class="video-editor">
  <header class="header">
    <div class="header__copy">
      <div class="chip-row">
        <span class="chip chip--accent">Live preview</span>
        <span class="chip chip--ghost">Dash.js + FFmpeg</span>
      </div>
      <h1>Precision video surgery</h1>
      <p>
        Stage trims, carve out awkward segments, and offload rendering to FFmpeg without risking
        your master asset. Everything happens in the browser until you choose to send it server-side.
      </p>
      <ul class="stat-grid">
        <li>
          <span class="stat-label">Trim accuracy</span>
          <strong>¬±50&nbsp;ms</strong>
        </li>
        <li>
          <span class="stat-label">Middle cuts</span>
          <strong>{{ cuts().length || 0 }}</strong>
        </li>
        <li>
          <span class="stat-label">Segment length</span>
          <strong>{{ formatTime(trimmedLength()) }}</strong>
        </li>
      </ul>
    </div>
    <div class="header__panel">
      <div class="status-card">
        <p class="status-label">Backend target</p>
        <strong>{{ backendHost }}</strong>
        <span class="status-pill" [class.status-pill--ready]="sourceLoaded()">
          {{ sourceLoaded() ? 'Source ready' : 'Waiting for source' }}
        </span>
      </div>
      <div class="header__actions">
        <button class="ghost" type="button" (click)="resetEditor(true)">Reset session</button>
        <button type="button" (click)="setTrimStartFromCurrent()" [disabled]="!sourceLoaded()">
          Mark in from playhead
        </button>
      </div>
      <p class="header__hint">
        Load a source URL below then scrub, cut, and ship render jobs without touching the original
        file.
      </p>
    </div>
  </header>

  <form class="source-form" [formGroup]="sourceForm" (ngSubmit)="loadVideo()">
    <label>
      Source URL
      <input
        formControlName="sourceUrl"
        type="url"
        placeholder="https://storage.example.com/demo.mp4 or .mpd"
        [class.invalid]="sourceForm.controls.sourceUrl.invalid && sourceForm.touched"
      />
    </label>
    <button type="submit" [disabled]="sourceForm.invalid || loading()">
      {{ loading() ? 'Loading‚Ä¶' : 'Load Source' }}
    </button>
  </form>

  <p *ngIf="errorMessage()" class="error">{{ errorMessage() }}</p>

  <section class="player" [class.player--idle]="!sourceLoaded()">
    <div class="player__placeholder" *ngIf="!sourceLoaded()">
      Paste an MP4 or MPEG-DASH URL and choose "Load Source".
    </div>
    <div class="player__container" #playerContainer>
      <video
        #videoEl
        [attr.controls]="sourceLoaded() ? '' : null"
        playsinline
        (loadedmetadata)="onMetadataLoaded()"
        (timeupdate)="onTimeUpdate()"
        (error)="onVideoError()"
      ></video>
      
      <!-- Overlay previews -->
      <div
        *ngFor="let overlay of getActiveOverlays()"
        class="overlay-preview"
        [class.overlay-preview--text]="overlay.type === 'text'"
        [class.overlay-preview--image]="overlay.type === 'image'"
        [class.overlay-preview--shape]="overlay.type === 'shape'"
        [class.overlay-preview--shape-circle]="overlay.type === 'shape' && getShapeOverlayType(overlay) === 'circle'"
        [class.overlay-preview--shape-rectangle]="overlay.type === 'shape' && getShapeOverlayType(overlay) === 'rectangle'"
        [class.overlay-preview--shape-arrow]="overlay.type === 'shape' && getShapeOverlayType(overlay) === 'arrow'"
        [class.overlay-preview--dragging]="draggingOverlay()?.overlay?.id === overlay.id"
        [class.overlay-preview--resizing]="resizingOverlay()?.overlay?.id === overlay.id"
        [style.left.%]="getOverlayLeftInContainer(overlay)"
        [style.top.%]="getOverlayTopInContainer(overlay)"
        [style.font-size.px]="overlay.type === 'text' ? getTextOverlayFontSize(overlay) : null"
        [style.color]="overlay.type === 'text' ? getTextOverlayFontColor(overlay) : null"
        [style.background-color]="overlay.type === 'shape' && getShapeOverlayFill(overlay) ? getShapeOverlayColor(overlay) : (overlay.type === 'text' && getTextOverlayBgColor(overlay) !== 'transparent' ? getTextOverlayBgColor(overlay) : null)"
        [style.opacity]="overlay.opacity ?? 1"
        [style.width.%]="overlay.type === 'image' || overlay.type === 'shape' ? getOverlayWidthInContainer(overlay) : null"
        [style.height.%]="overlay.type === 'image' || overlay.type === 'shape' ? getOverlayHeightInContainer(overlay) : null"
        [style.border]="overlay.type === 'shape' && !getShapeOverlayFill(overlay) ? (getShapeOverlayStrokeWidth(overlay) + 'px solid ' + getShapeOverlayColor(overlay)) : null"
        [style.box-sizing]="overlay.type === 'shape' ? 'border-box' : null"
        (pointerdown)="startDragOverlay(overlay, $event)"
        (pointermove)="resizingOverlay() ? resizeOverlay($event) : dragOverlay($event)"
        (pointerup)="stopDragOverlay(); stopResizeOverlay()"
        (pointerleave)="stopDragOverlay(); stopResizeOverlay()"
      >
        <span *ngIf="overlay.type === 'text'">{{ getOverlayText(overlay) }}</span>
        <img *ngIf="overlay.type === 'image'" [src]="getOverlayImageUrl(overlay)" alt="Overlay" />
        <!-- Arrow shape uses SVG, others use CSS -->
        <svg 
          *ngIf="overlay.type === 'shape' && getShapeOverlayType(overlay) === 'arrow'" 
          class="overlay-preview__shape-svg" 
          [attr.viewBox]="'0 0 100 100'"
          preserveAspectRatio="none"
        >
          <path
            d="M 5 50 L 75 50 M 65 35 L 80 50 L 65 65"
            [attr.fill]="getShapeOverlayFill(overlay) ? getShapeOverlayColor(overlay) : 'none'"
            [attr.stroke]="getShapeOverlayColor(overlay)"
            [attr.stroke-width]="getShapeOverlayStrokeWidth(overlay)"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <!-- Resize handles for images and shapes -->
        <div
          *ngIf="overlay.type === 'image' || overlay.type === 'shape'"
          class="overlay-preview__resize-handles"
        >
          <div
            class="overlay-preview__resize-handle overlay-preview__resize-handle--nw"
            (pointerdown)="startResizeOverlay(overlay, $event, 'nw'); $event.stopPropagation()"
          ></div>
          <div
            class="overlay-preview__resize-handle overlay-preview__resize-handle--ne"
            (pointerdown)="startResizeOverlay(overlay, $event, 'ne'); $event.stopPropagation()"
          ></div>
          <div
            class="overlay-preview__resize-handle overlay-preview__resize-handle--sw"
            (pointerdown)="startResizeOverlay(overlay, $event, 'sw'); $event.stopPropagation()"
          ></div>
          <div
            class="overlay-preview__resize-handle overlay-preview__resize-handle--se"
            (pointerdown)="startResizeOverlay(overlay, $event, 'se'); $event.stopPropagation()"
          ></div>
        </div>
      </div>
    </div>

    <div class="player-controls" [class.disabled]="!sourceLoaded()">
      <button type="button" (click)="togglePlayPause()" [disabled]="!sourceLoaded()">
        Play / Pause
      </button>
      <button type="button" (click)="jumpTo(trimStart())" [disabled]="!sourceLoaded()">
        Jump to Trim Start
      </button>
      <button type="button" (click)="jumpTo(trimEnd())" [disabled]="!sourceLoaded()">
        Jump to Trim End
      </button>
      <span>Current: {{ formatTime(currentTime()) }}</span>
      <span>Duration: {{ formatTime(duration()) }}</span>
    </div>
  </section>

  <section
    class="timeline-shell"
    *ngIf="sourceLoaded()"
  >
    <div class="timeline-meta">
      <h2>Unified timeline</h2>
      <p>Click to move the playhead. Hold <kbd>Shift</kbd> and drag to stage a cut selection.</p>
    </div>
    <div
      class="timeline"
      (pointerdown)="onTimelinePointerDown($event)"
      (pointermove)="onTimelinePointerMove($event)"
      (pointerup)="onTimelinePointerUp($event)"
      (pointerleave)="onTimelinePointerLeave()"
    >
      <div class="timeline__rail"></div>
      <div class="timeline__shade timeline__shade--left" [style.width.%]="percentFor(trimStart())"></div>
      <div
        class="timeline__shade timeline__shade--right"
        [style.width.%]="100 - percentFor(trimEnd())"
      ></div>
      <div
        *ngFor="let cut of cuts()"
        class="timeline__cut"
        [style.left.%]="percentFor(cut.start)"
        [style.width.%]="percentSpan(cut.start, cut.end)"
        (click)="focusCut(cut, $event)"
      ></div>
      <div
        class="timeline__cut timeline__cut--active"
        *ngIf="hasCuts()"
        [style.left.%]="percentFor(cutSelection().start)"
        [style.width.%]="percentSpan(cutSelection().start, cutSelection().end)"
      ></div>
      <div
        class="timeline__cut timeline__cut--pending"
        *ngIf="timelineSelection()"
        [style.left.%]="percentFor(timelineSelection()?.start || 0)"
        [style.width.%]="percentSpan(timelineSelection()?.start || 0, timelineSelection()?.end || 0)"
      ></div>
      <div
        *ngFor="let overlay of overlays()"
        class="timeline__overlay"
        [class.timeline__overlay--text]="overlay.type === 'text'"
        [class.timeline__overlay--image]="overlay.type === 'image'"
        [style.left.%]="percentFor(overlay.start)"
        [style.width.%]="percentSpan(overlay.start, overlay.end)"
        (click)="focusOverlay(overlay, $event)"
        [title]="getOverlayTitle(overlay)"
      ></div>
      <div class="timeline__playhead" [style.left.%]="percentFor(currentTime())"></div>
    </div>
  </section>

  <section class="cuts-panel" *ngIf="duration() > 0">
    <div class="cuts-panel__form">
      <h2>Manual cut entry</h2>
      <p>Provide start/end (in seconds) or capture values from the playhead.</p>
      <div class="field-grid">
        <label>
          Start (sec)
          <input
            type="number"
            step="0.05"
            [min]="0"
            [max]="duration()"
            [value]="cutSelection().start"
            (input)="updateCutSelection('start', $event)"
          />
        </label>
        <label>
          End (sec)
          <input
            type="number"
            step="0.05"
            [min]="0"
            [max]="duration()"
            [value]="cutSelection().end"
            (input)="updateCutSelection('end', $event)"
          />
        </label>
      </div>
      <div class="hint">
        <button type="button" (click)="setCutStartFromCurrent()">Use playhead for start</button>
        <button type="button" (click)="setCutEndFromCurrent()">Use playhead for end</button>
        <button type="button" class="primary" (click)="addCut()">Add cut</button>
      </div>
    </div>

    <div class="cuts-panel__list">
      <h2>Cut queue</h2>
      <ul class="cuts" *ngIf="hasCuts(); else noCuts">
        <li *ngFor="let cut of cuts()">
          <div class="cuts__times">
            <span>{{ formatTime(cut.start) }} ‚Äì {{ formatTime(cut.end) }}</span>
            <small>{{ formatTime(cut.end - cut.start) }}</small>
          </div>
          <div class="cuts__actions">
            <button type="button" (click)="jumpTo(cut.start)">Preview</button>
            <button type="button" class="ghost" (click)="removeCut(cut.id)">Remove</button>
          </div>
        </li>
      </ul>
      <ng-template #noCuts>
        <p class="muted">No cuts added yet.</p>
      </ng-template>
    </div>
  </section>

  <section class="overlays-panel" *ngIf="duration() > 0">
    <div class="overlays-panel__header">
      <h2>Overlays</h2>
      <div class="overlays-panel__actions">
        <button type="button" (click)="openOverlayForm('text')">Add Text</button>
        <button type="button" (click)="openOverlayForm('image')">Add Image</button>
        <button type="button" (click)="openOverlayForm('shape')">Add Shape</button>
      </div>
    </div>

    <div class="overlay-form" *ngIf="showOverlayForm()" #overlayFormContainer>
      <h3>Add {{ overlayFormType() === 'text' ? 'Text' : overlayFormType() === 'image' ? 'Image' : 'Shape' }} Overlay</h3>
      
      <div class="field-grid" *ngIf="overlayFormType() === 'text'">
        <label>
          Text
          <input type="text" id="textInput" placeholder="Enter text" />
        </label>
        <label>
          Start (sec)
          <input type="number" id="textStart" step="0.1" [value]="currentTime()" />
        </label>
        <label>
          End (sec)
          <input type="number" id="textEnd" step="0.1" [value]="currentTime() + 5" />
        </label>
        <label>
          X Position (%)
          <input type="number" id="textX" step="1" min="0" max="100" value="10" readonly />
        </label>
        <label>
          Y Position (%)
          <input type="number" id="textY" step="1" min="0" max="100" value="10" readonly />
        </label>
        <p class="hint-text">üí° Drag the text overlay on the video to position it</p>
        <label>
          Font Size
          <input type="number" id="textFontSize" step="1" min="12" max="200" value="24" />
        </label>
        <label>
          Font Color
          <input type="color" id="textFontColor" value="#FFFFFF" />
        </label>
        <label>
          Background Color
          <input type="color" id="textBgColor" value="#000000" />
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="checkbox" id="textBgTransparent" />
          <span>Transparent background</span>
        </label>
        <label>
          Opacity (0-1)
          <input type="number" id="textOpacity" step="0.1" min="0" max="1" value="1" />
        </label>
      </div>

      <div class="field-grid" *ngIf="overlayFormType() === 'image'">
        <label>
          Image URL
          <input type="url" id="imageUrl" placeholder="https://example.com/image.png" />
        </label>
        <label>
          Start (sec)
          <input type="number" id="imageStart" step="0.1" [value]="currentTime()" />
        </label>
        <label>
          End (sec)
          <input type="number" id="imageEnd" step="0.1" [value]="currentTime() + 5" />
        </label>
        <label>
          X Position (%)
          <input type="number" id="imageX" step="1" min="0" max="100" value="10" readonly />
        </label>
        <label>
          Y Position (%)
          <input type="number" id="imageY" step="1" min="0" max="100" value="10" readonly />
        </label>
        <p class="hint-text">üí° Drag the image overlay on the video to position it</p>
        <label>
          Width (%)
          <input type="number" id="imageWidth" step="1" min="1" max="100" value="20" />
        </label>
        <label>
          Height (%)
          <input type="number" id="imageHeight" step="1" min="1" max="100" value="20" />
        </label>
        <label>
          Opacity (0-1)
          <input type="number" id="imageOpacity" step="0.1" min="0" max="1" value="1" />
        </label>
      </div>

      <div class="field-grid" *ngIf="overlayFormType() === 'shape'">
        <label>
          Shape Type
          <select id="shapeType">
            <option value="circle">Circle</option>
            <option value="rectangle">Rectangle</option>
            <option value="arrow">Arrow</option>
          </select>
        </label>
        <label>
          Start (sec)
          <input type="number" id="overlayStart" step="0.1" [value]="currentTime()" />
        </label>
        <label>
          End (sec)
          <input type="number" id="overlayEnd" step="0.1" [value]="currentTime() + 5" />
        </label>
        <label>
          X Position (%)
          <input type="number" id="overlayX" step="1" min="0" max="100" value="10" readonly />
        </label>
        <label>
          Y Position (%)
          <input type="number" id="overlayY" step="1" min="0" max="100" value="10" readonly />
        </label>
        <p class="hint-text">üí° Drag the shape overlay on the video to position it</p>
        <label>
          Width (%)
          <input type="number" id="shapeWidth" step="1" min="1" max="100" value="20" />
        </label>
        <label>
          Height (%)
          <input type="number" id="shapeHeight" step="1" min="1" max="100" value="20" />
        </label>
        <label>
          Color
          <input type="color" id="shapeColor" value="#FF0000" />
        </label>
        <label>
          Stroke Width
          <input type="number" id="shapeStrokeWidth" step="1" min="1" max="20" value="3" />
        </label>
        <label>
          <input type="checkbox" id="shapeFill" /> Fill shape
        </label>
        <label>
          Opacity (0-1)
          <input type="number" id="shapeOpacity" step="0.1" min="0" max="1" value="1" />
        </label>
      </div>

      <div class="hint">
        <button type="button" (click)="closeOverlayForm()">Cancel</button>
        <button
          type="button"
          class="primary"
          *ngIf="overlayFormType() === 'text'"
          (click)="addTextOverlayFromForm()"
        >
          Add Text Overlay
        </button>
        <button
          type="button"
          class="primary"
          *ngIf="overlayFormType() === 'image'"
          (click)="addImageOverlayFromForm()"
        >
          Add Image Overlay
        </button>
        <button
          type="button"
          class="primary"
          *ngIf="overlayFormType() === 'shape'"
          (click)="addShapeOverlayFromForm()"
        >
          Add Shape Overlay
        </button>
      </div>
    </div>

    <div class="overlays-panel__list">
      <h3>Overlay Queue</h3>
      <ul class="overlays" *ngIf="hasOverlays(); else noOverlays">
        <li *ngFor="let overlay of overlays()">
          <div class="overlays__info">
            <span class="overlays__type">{{ overlay.type === 'text' ? 'üìù Text' : overlay.type === 'image' ? 'üñºÔ∏è Image' : 'üî∑ Shape' }}</span>
            <span class="overlays__times">
              {{ formatTime(overlay.start) }} ‚Äì {{ formatTime(overlay.end) }}
            </span>
            <small *ngIf="overlay.type === 'text'">{{ getOverlayText(overlay) }}</small>
            <small *ngIf="overlay.type === 'image'">{{ getOverlayImageUrl(overlay) }}</small>
            <small *ngIf="overlay.type === 'shape'">{{ getOverlayTitle(overlay) }}</small>
          </div>
          <div class="overlays__actions">
            <button type="button" (click)="focusOverlay(overlay)">Preview</button>
            <button type="button" class="ghost" (click)="removeOverlay(overlay.id)">Remove</button>
          </div>
        </li>
      </ul>
      <ng-template #noOverlays>
        <p class="muted">No overlays added yet.</p>
      </ng-template>
    </div>
  </section>

  <section class="summary" *ngIf="duration() > 0">
    <h2>Export Plan</h2>
    <ol>
      <li *ngFor="let step of exportPlan()">{{ step }}</li>
    </ol>
    <p class="muted">
      This is a UI prototype. Hook these staged edits into your encoding pipeline
      (ffmpeg, MediaConvert, etc.) to produce the final asset.
    </p>
  </section>

  <section class="server-panel" *ngIf="duration() > 0">
    <div>
      <h2>Server Render (FFmpeg)</h2>
      <p>
        Send the current trim/cut plan to the Node backend. The server downloads from the provided
        URL, cuts the requested keep segments, concatenates them, and writes a new file without
        mutating the original.
      </p>
    </div>
    <div class="server-panel__actions">
      <button
        type="button"
        class="primary"
        [disabled]="!canRender() || renderBusy()"
        (click)="renderViaBackend()"
      >
        {{ renderBusy() ? 'Rendering‚Ä¶' : 'Send to backend' }}
      </button>
      <div *ngIf="renderResult(); else noRender" class="render-result">
        <p class="render-result__info">
          Job {{ renderResult()?.jobId }} ready
        </p>
        <div class="render-result__player" *ngIf="renderDownloadUrl()">
          <video
            #renderedVideo
            [src]="renderDownloadUrl() || undefined"
            controls
            class="render-result__video"
          ></video>
        </div>
        <a
          class="download-link"
          [href]="renderDownloadUrl() || undefined"
          download
          target="_blank"
          rel="noopener"
        >
          Download output
        </a>
      </div>
      <ng-template #noRender>
        <p class="muted">No server job yet.</p>
      </ng-template>
    </div>
  </section>
</section>

